# Security Guide

## 1 Provisioning the Device Using the Digital Signature Peripheral

To provision the Digital Signature Peripheral for this project, you must have:

* A **PEM-encoded device certificate:** This is a certificate signed by the Amazon Root CA attached to the thing.
* A **PEM-encoded private key:** This is the private key corresponding to the device certificate.
* A **PEM-encoded root CA certificate:** This is the Amazon Root CA which can be downloaded [here](https://www.amazontrust.com/repository/AmazonRootCA1.pem).

Additionally, if you plan on using OTA, you must have:

* A **PEM-encoded code signing private key**: This is the private key that will be used to sign code for OTA updates from AWS.
* A **PEM-encoded code signing certificate**: This is the code signing certificate the OTA demo will use to verify the signature of an OTA update.

These can be generated by running the following commands:

```
openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:P-256 -pkeyopt ec_param_enc:named_curve -outform PEM -out ecdsasigner.key
```

```
openssl req -new -x509 -config cert_config.txt -extensions my_exts -nodes -days 365 -key ecdsasigner.key -out ecdsasigner.crt
```

The **PEM-encoded code signing private key** will be output as `ecdsasigner.key` and the **PEM-encoded code signing certificate** will be output as `ecdsasigner.crt`.

**NOTE**: `ecdsasigner.crt` will only work for as many days as the integer given to the `-days` argument of the second command.

### 1.1 Configuring the Project to Use the Digital Signature Peripheral

1. Open the ESP-IDF menuconfig.
    1. **Terminal/Command Prompt Users**
        1. Open the ESP-IDF Terminal/Command Prompt
        2. Set the directory to the root of this project.
        3. Run `idf.py menuconfig`.
    2. **Visual Studio Code Users**
        1. Open this project in Visual Studio Code with the Espressif IDF extension.
        2. Click **View** at the top.
        3. Click **Command Palette** in the dropdown menu.
        4. Search for `ESP-IDF: SDK Configuration editor (menuconfig)` and select the command.
        5. The `SDK Configuration editor` window should pop up after a moment.
2. Select `Component config`.
3. Select `ESP-TLS`.
4. Set `Use Digital Signature (DS) Peripheral with ESP-TLS` to true.
5. Go back to the `Component config` menu.
6. Select `ESP Secure Cert Manager`.
7. Set `Enable DS peripheral support` to true.
8. Save these settings.

**NOTE**: The project must be rebuilt and flashed after the project has been configured.

### 1.2 Provisioning Keys and Certificates Using the Digital Signature Peripheral

For provisioning keys and certificates, this project utilizes the [ESP Secure Certificate Manager](https://github.com/espressif/esp_secure_cert_mgr). This requires that the `esp_secure_cert` partition on the ESP32-C3 be written. To generate and write this partition for use with the Digital Signature Peripheral, follow these steps:

1. Open the ESP-IDF Terminal/Command Prompt
    1. **Visual Studio Code Users**
        1. Click **View** at the top.
        2. Click **Command Palette** in the dropdown menu.
        3. Search for `ESP-IDF: Open ESP-IDF Terminal` and select the command.
        4. The `ESP-IDF Terminal` will open at the bottom.
2. Set the directory to the root of this project.
3. Create the `esp_secure_crt` partition binary.

    1. If provisioning without the **PEM-encoded code signing certificate**, run the following command **NOTE**: If this is the first time running this command, a block in the ESP32-C3's will be burnt and this **CANNOT** be reverse:
```
python components/esp_secure_cert_mgr/tools/configure_esp_secure_cert.py -p PORT --configure_ds --keep_ds_data_on_host --ca-cert CA_CERT_FILEPATH --device-cert DEVICE_CERT_FILEPATH --private-key PRIVATE_KEY_FILEPATH --target_chip esp32c3 --secure_cert_type cust_flash
```
Replace:
* **PORT** with the serial port of the ESP32-C3.
* **CA_CERT_FILEPATH** with the file path to the **PEM-encoded root CA certificate**.
* **DEVICE_CERT_FILEPATH** with the file path to the **PEM-encoded device certificate**.
* **PRIVATE_KEY_FILEPATH** with the file path to the **PEM-encoded private key**.

    2. If provisioning with the **PEM-encoded code signing certificate**, run the following command:
```
python components/esp_secure_cert_mgr/tools/configure_esp_secure_cert.py -p PORT --configure_ds --keep_ds_data_on_host --ca-cert CA_CERT_FILEPATH --device-cert DEVICE_CERT_FILEPATH --private-key PRIVATE_KEY_FILEPATH --cs-cert CS_CERT_FILEPATH --target_chip esp32c3 --secure_cert_type cust_flash
```
Replace:
* **PORT** with the serial port of the ESP32-C3.
* **CA_CERT_FILEPATH** with the file path to the **PEM-encoded root CA certificate**.
* **DEVICE_CERT_FILEPATH** with the file path to the **PEM-encoded device certificate**.
* **PRIVATE_KEY_FILEPATH** with the file path to the **PEM-encoded private key**.
* **CS_CERT_FILEPATH** with the file path to the **PEM-encoded code signing certificate**.

4. Write the `esp_secure_crt` partition binary (stored in `esp_ds_data/esp_secure_crt.bin`) to the ESP32-C3's flash by running the following command:
```
esptool.py --no-stub --port PORT write_flash 0xD000 esp_ds_data/esp_secure_cert.bin
```
Replace:
* **PORT** with the serial port of the ESP32-C3.

**NOTE**: The project does not have to rebuilt if it's currently flashed with a build with the configurations of Section 1.1.

## 2 Enabling Flash Encryption

### 2.1 Enabling Flash Encryption in Development Mode

### 2.2 Enabling Flash Encryption in Release Mode

## 3 Enabling Secure Boot

### 2.1 Enabling Secure Boot in Development Mode

### 2.2 Enabling Secure Boot in Release Mode